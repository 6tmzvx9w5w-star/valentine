<script>
  const name = "Subina";

  const headline = document.getElementById("headline");
  const msg = document.getElementById("msg");
  const hint = document.getElementById("hint");
  const stage = document.getElementById("stage");
  const hearts = document.getElementById("hearts");
  const footer = document.getElementById("footer");

  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");

  headline.textContent = `${name}, willst du mein Valentinsdate sein?`;

  function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function spawnHeart() {
    const h = document.createElement("div");
    h.className = "heart";
    h.textContent = "ðŸ’—";
    const rect = stage.getBoundingClientRect();
    const x = rand(20, Math.max(20, Math.floor(rect.width - 20)));
    const y = rand(Math.floor(rect.height * 0.55), Math.floor(rect.height * 0.75));
    h.style.left = x + "px";
    h.style.top = y + "px";
    hearts.appendChild(h);
    setTimeout(() => h.remove(), 1300);
  }

  const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  function viewportBox(btnW, btnH) {
    const pad = 8;
    const w = Math.max(0, window.innerWidth - btnW - pad);
    const h = Math.max(0, window.innerHeight - btnH - pad);
    return { pad, w, h };
  }

  function setNoFixedMode() {
    noBtn.style.position = "fixed";
    noBtn.style.left = "12px";
    noBtn.style.top = "12px";
    noBtn.style.transform = "translate(0,0)";
    noBtn.style.zIndex = "9999";
    noBtn.style.margin = "0";
  }

  function teleportNoRandom() {
    if (noBtn.classList.contains("is-yes")) return;

    const rect = noBtn.getBoundingClientRect();
    const box = viewportBox(rect.width, rect.height);

    const x = rand(box.pad, box.w);
    const y = rand(box.pad, box.h);

    noBtn.style.left = x + "px";
    noBtn.style.top = y + "px";
  }

  let vx = 0;
  let vy = 0;
  let ticker = null;

  function randomVelocity() {
    const speed = rand(18, 34);
    const angle = Math.random() * Math.PI * 2;
    vx = Math.cos(angle) * speed;
    vy = Math.sin(angle) * speed;
  }

  function tick() {
    if (noBtn.classList.contains("is-yes")) return;

    const rect = noBtn.getBoundingClientRect();
    const box = viewportBox(rect.width, rect.height);

    let x = rect.left + vx;
    let y = rect.top + vy;

    let bounced = false;

    if (x < box.pad) { x = box.pad; vx = Math.abs(vx); bounced = true; }
    if (x > box.w)   { x = box.w;   vx = -Math.abs(vx); bounced = true; }
    if (y < box.pad) { y = box.pad; vy = Math.abs(vy); bounced = true; }
    if (y > box.h)   { y = box.h;   vy = -Math.abs(vy); bounced = true; }

    noBtn.style.left = x + "px";
    noBtn.style.top = y + "px";

    if (bounced && Math.random() < 0.35) randomVelocity();
  }

  function startChaos() {
    if (prefersReducedMotion) return;
    if (ticker) return;

    randomVelocity();
    teleportNoRandom();

    ticker = setInterval(() => {
      for (let i = 0; i < 2; i++) tick();
    }, 16);
  }

  function stopChaos() {
    if (!ticker) return;
    clearInterval(ticker);
    ticker = null;
  }

  function panicJumpAwayFromPoint(clientX, clientY) {
    if (noBtn.classList.contains("is-yes")) return;

    const rect = noBtn.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;

    const dx = cx - clientX;
    const dy = cy - clientY;
    const dist = Math.hypot(dx, dy);

    const danger = 170;
    if (dist > danger) return;

    teleportNoRandom();
    randomVelocity();
  }

  function centerNoAndMakeYes() {
    stopChaos();

    noBtn.classList.add("is-yes");
    noBtn.textContent = "Ja";
    msg.textContent = "Nein hat sich korrigiert. VerstÃ¤ndlich.";
    hint.textContent = "Tippe auf Ja.";

    const rect = noBtn.getBoundingClientRect();
    const x = (window.innerWidth - rect.width) / 2;
    const y = (window.innerHeight - rect.height) / 2;

    noBtn.style.left = Math.max(8, x) + "px";
    noBtn.style.top = Math.max(8, y) + "px";

    for (let i = 0; i < 10; i++) setTimeout(spawnHeart, i * 70);

    const toYes = (e) => {
      e.preventDefault();
      yesBtn.click();
    };

    noBtn.addEventListener("click", toYes, { once: true });
    noBtn.addEventListener("pointerup", toYes, { once: true });
    noBtn.addEventListener("touchend", toYes, { passive: false, once: true });
  }

  function armNoButton() {
    setNoFixedMode();
    startChaos();

    const caught = (e) => {
      e.preventDefault();
      if (noBtn.classList.contains("is-yes")) return;
      centerNoAndMakeYes();
    };

    noBtn.addEventListener("pointerdown", caught);
    noBtn.addEventListener("touchstart", caught, { passive: false });
    noBtn.addEventListener("mousedown", caught);

    window.addEventListener("pointermove", (e) => {
      panicJumpAwayFromPoint(e.clientX, e.clientY);
    });

    window.addEventListener("touchmove", (e) => {
      const t = e.touches && e.touches[0];
      if (!t) return;
      panicJumpAwayFromPoint(t.clientX, t.clientY);
    }, { passive: true });

    window.addEventListener("resize", () => {
      if (noBtn.classList.contains("is-yes")) {
        const rect = noBtn.getBoundingClientRect();
        noBtn.style.left = Math.max(8, (window.innerWidth - rect.width) / 2) + "px";
        noBtn.style.top = Math.max(8, (window.innerHeight - rect.height) / 2) + "px";
        return;
      }
      teleportNoRandom();
      randomVelocity();
    });
  }

  yesBtn.addEventListener("click", () => {
    msg.textContent = "Sehr gute Entscheidung. Speicherung im Herzen abgeschlossen.";
    hint.textContent = "Screenshot machen und mir schicken ðŸ˜Œ";
    footer.textContent = "";

    for (let i = 0; i < 14; i++) setTimeout(spawnHeart, i * 60);

    stopChaos();
    noBtn.style.display = "none";

    yesBtn.style.left = "50%";
    yesBtn.style.top = "58%";
    yesBtn.style.transform = "translate(-50%, -50%)";
  });

  msg.textContent = "";
  hint.textContent = "Pro Tipp: Fang den Nein Button. Spoiler: wirst du nicht.";
  footer.textContent = "";

  armNoButton();
</script>
